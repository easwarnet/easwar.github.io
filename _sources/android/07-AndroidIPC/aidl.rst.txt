07-AndroidIPC - Android Interface Definition Language (AIDL) 
=========================================================================
The Android Interface Definition Language (AIDL) is Interface Descriptive Language that allows you to define the programming interface that both the client and service using interprocess communication (IPC). RPC is used to call the remote methods. AIDL interfaceuses direct function calls.

- Calls made from the local process are executed in the same thread that is making the call. If this is your main UI thread, that thread continues to execute in the AIDL interface. If it is another thread, that is the one that executes your code in the service. Thus, if only local threads are accessing the service, you can completely control which threads are executing in it (but if that is the case, then you shouldn't be using AIDL at all, but should instead create the interface by implementing a Binder).
- Calls from a remote process are dispatched from a thread pool the platform maintains inside of your own process. You must be prepared for incoming calls from unknown threads, with multiple calls happening at the same time. In other words, an implementation of an AIDL interface must be completely thread-safe. Calls made from one thread on the same remote object arrive in order on the receiver end.
- The oneway keyword modifies the behavior of remote calls. When used, a remote call does not block; it simply sends the transaction data and immediately returns. The implementation of the interface eventually receives this as a regular call from the Binder thread pool as a normal remote call. If oneway is used with a local call, there is no impact and the call is still synchronous.

Defining an AIDL interface:
-----------------------------
You must define your AIDL interface in an .aidl file using the Java programming language syntax, then save it in the source code (in the src/ directory) of both the application hosting the service and any other application that binds to the service.

To create a bounded service using AIDL, follow these steps:

1. Aidl file

Example AIDL File

.. code-block:: java

    // IRemoteService.aidl
    package com.example.android;

    // Declare any non-default types here with import statements

    /** Example service interface */
    interface IRemoteService {
        String message();
    }

Simply save your .aidl file in your project's src/ directory and when you build your application, the SDK tools generate the IBinder interface file in your project's gen/ directory. The generated file name matches the .aidl file name, but with a .java extension (for example, IRemoteService.aidl results in IRemoteService.java).

2. Implement Interface

The Android SDK tools generate an interface in the Java programming language, based on your .aidl file. This interface has an inner abstract class named Stub that extends Binder and implements methods from your AIDL interface. You must extend the Stub class and implement the methods.

When you build your application, the Android SDK tools generate a .java interface file named after your .aidl file. The generated interface includes a subclass named Stub that is an abstract implementation of its parent interface (for example, YourInterface.Stub) and declares all the methods from the .aidl file.

To implement the interface generated from the .aidl, extend the generated Binder interface (for example, YourInterface.Stub) and implement the methods inherited from the .aidl file. Implement a Service and override onBind() to return your implementation of the Stub class. Once you've implemented the interface for your service, you need to expose it to clients so they can bind to it. To expose the interface for your service, extend Service and implement onBind() to return an instance of your class that implements the generated Stub (as discussed in the previous section). Here's an example service that implement an interface called IRemoteService and exposes the IRemoteService example interface to clients.

Here is an example (defined by the IRemoteService.aidl example, above) using an anonymous instance:
 
.. code-block:: java

    public class AidlRemoteServiceStub extends Service {

        private static final String TAG = "AidlRemoteServiceStub";
        private static final String className = this.getClass().getSimpleName();

        public AidlRemoteServiceStub() {
            Log.i(TAG, className+" Constructor");
        }

        @Override
        public IBinder onBind(Intent intent) {
            Log.i(TAG, className+" onBind");
            return IRemoteService.asBinder();
        }

        @Override
        public void onCreate() {
            super.onCreate();
            Log.i(TAG, className+" onCreate");
        }

        @Override
        public void onDestroy() {
            super.onDestroy();
            Log.i(TAG, className+" onDestroy");
        }

        IRemoteService.Stub iRemoteService = new IRemoteService.Stub() {
            @Override
            public int message() throws RemoteException {
                return "Message from AIDL Stub";
            }
        };
    }

Now the binder is an instance of the Stub class (a Binder), which defines the RPC interface for the service. In the next step, this instance is exposed to clients so they can interact with the service.

3. Client Implementation

Now, when a client (such as an activity) calls bindService() to connect to this service, the client's onServiceConnected() callback receives the binder instance returned by the service's onBind() method.

The client must also have access to the interface class, so if the client and service are in separate applications, then the client's application must have a copy of the .aidl file in its src/ directory (which generates the android.os.Binder interfaceâ€”providing the client access to the AIDL methods).

When the client receives the IBinder in the onServiceConnected() callback, it must call YourServiceInterface.Stub.asInterface(service) to cast the returned parameter to YourServiceInterface type. For example:

.. code-block:: java

    public class AIDLDemo extends Activity {
        private static final String TAG = "AIDLDemo";
        IRemoteService service;
        RemoteServiceConnection connection;
        String message;

        /**
        * This class represents the actual service connection. It casts the bound
        * stub implementation of the service to the AIDL interface.
        */
        class RemoteServiceConnection implements ServiceConnection {

            public void onServiceConnected(ComponentName name, IBinder boundService) {
                service = IRemoteService.Stub.asInterface((IBinder) boundService);
                Log.d(TAG, "onServiceConnected() connected");
            }

            public void onServiceDisconnected(ComponentName name) {
                service = null;
                Log.d(TAG, "onServiceDisconnected() disconnected");
            }
        }

        /** Binds this activity to the service. */
        private void initService() {
            connection = new RemoteServiceConnection();
            Intent i = new Intent();
            boolean ret = bindService(i, connection, Context.BIND_AUTO_CREATE);
            Log.d(TAG, "initService() bound with " + ret);
        }

        /** Unbinds this activity from the service. */
        private void releaseService() {
            unbindService(connection);
            connection = null;
            Log.d(TAG, "releaseService() unbound.");
        }

        /** Called when the activity is first created. */
        @Override
        public void onCreate(Bundle savedInstanceState) {
            super.onCreate(savedInstanceState);
            setContentView(R.layout.main);

            initService();

            try {
                message = service.message();
                Log.d(TAG, "Message received: " + message);
            } catch (RemoteException e) {
                Log.d(TAG, "Service Request failed with: " + e);
                e.printStackTrace();
            }
        }

        /** Called when the activity is about to be destroyed. */
        @Override
        protected void onDestroy() {
            releaseService();
        }
    }
    
Calling an IPC method:
------------------------
Here are the steps a calling class must take to call a remote interface defined with AIDL:

- Include the .aidl file in the project src/ directory.
- Declare an instance of the IBinder interface (generated based on the AIDL).
- Implement ServiceConnection.
- Call Context.bindService(), passing in your ServiceConnection implementation.
- In your implementation of onServiceConnected(), you will receive an IBinder instance (called service). Call YourInterfaceName.Stub.asInterface((IBinder)service) to cast the returned parameter to YourInterface type.
- Call the methods that you defined on your interface. You should always trap DeadObjectException exceptions, which are thrown when the connection has broken. You should also trap SecurityException exceptions, which are thrown when the two processes involved in the IPC method call have conflicting AIDL definitions.
- To disconnect, call Context.unbindService() with the instance of your interface.

A few comments on calling an IPC service:
- Objects are reference counted across processes.
- You can send anonymous objects as method arguments.

For more information about binding to a service, read the Bound Services document.

Reference:
-----------
[1]: ``https://developer.android.com/guide/components/aidl``


