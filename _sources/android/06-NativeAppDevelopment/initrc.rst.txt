06-NativeAppDevelopment - Init RC  
===================================
Init.rc file plays key role in boot sequence. Android's init.rc is different from Linux. Init.rc is used to initialize Services, namespaces, permissions, create/access properties, etc.

Init.Rc consists of 5 classes of statements
- Actions
- Commands
- Services
- Options
- Triggers

Actions
---------
Actions are sequence of commands. They have a trigger which shall determine on what actions needs to be executed.

Template for Action:

.. code-block::

    On <trigger>
        <command>
        <command>
        <command>

For example:
~~~~~~~~~~~~~~

**1. General**

In this case when the system is in boot stage, then the order of the commands will be executed

.. code-block::

    on boot
      setprop test 1

**2. With condition**

In this case if the property test is true then the order of the commands will be executed

.. code-block::

    on boot && property:test=true
          setprop testa 1
          setprop testb 2

Services
---------
Services are programs which init launches and (optionally) restart when it exists

**Template for Action:**

.. code-block::

    service <name> <pathname> [ <argument> ]
          <option>
          <option>
          . . .

Options
---------
Options are modifiers to services. They affect how and when init runs the service.

**namespace <pid|mnt>**

Enter a new PID or mount namespace when forking the service.

**oneshot**

Do not restart the service when it exits.

**onrestart**

Execute a Command when service restarts.

**override**

Indicates that this service definition is meant to override a previous definition for a service with the same name. This is typically meant for services on /odm to override those defined on /vendor. The last service definition that init parses with this keyword is the service definition will use for this service. Pay close attention to the order in which init.rc files are parsed, since it has some peculiarities for backwards compatibility reasons. The ‘imports’ section of this file has more details on the order.

**priority <priority>**

Scheduling priority of the service process. This value has to be in range -20 to 19. Default priority is 0. Priority is set via setpriority().

**disabled**

This service will not automatically start with its class. It must be explicitly started by name or by interface name.

**reboot_on_failure <target>**

If this process cannot be started or if the process terminates with an exit code other than CLD_EXITED or an status other than ‘0’, reboot the system with the target specified in target. target takes the same format as the parameter to sys.powerctl. This is particularly intended to be used with the exec_start builtin for any must-have checks during boot.

**restart_period <seconds>**

If a non-oneshot service exits, it will be restarted at its start time plus this period. It defaults to 5s to rate limit crashing services. This can be increased for services that are meant to run periodically. For example, it may be set to 3600 to indicate that the service should run every hour or 86400 to indicate that the service should run every day.

**rlimit <resource> <cur> <max>**

This applies the given rlimit to the service. rlimits are inherited by child processes, so this effectively applies the given rlimit to the process tree started by this service. It is parsed similarly to the setrlimit command specified below.

**seclabel <seclabel>**

Change to ‘seclabel’ before exec'ing this service. Primarily for use by services run from the rootfs, e.g. ueventd, adbd. Services on the system partition can instead use policy-defined transitions based on their file security context. If not specified and no transition is defined in policy, defaults to the init context.

**setenv <name> <value>**

Set the environment variable name to value in the launched process.

**shutdown <shutdown_behavior>**

Set shutdown behavior of the service process. When this is not specified, the service is killed during shutdown process by using SIGTERM and SIGKILL. The service with shutdown_behavior of “critical” is not killed during shutdown until shutdown times out. When shutdown times out, even services tagged with “shutdown critical” will be killed. When the service tagged with “shutdown critical” is not running when shut down starts, it will be started.

Triggers
---------
Triggers are strings which can be used to match certain kinds of events and used to cause an action to occur.

Triggers are subdivided into

- Event Triggers
- Property Triggers.

**Event Triggers**

are strings triggered by the ‘trigger’ command or by the QueueEventTrigger() function within the init executable. These take the form of a simple string such as ‘boot’ or ‘late-init’.

**Property Triggers**

are strings triggered when a named property changes value to a given new value or when a named property changes value to any new value. These take the form of ‘property:=’ and ‘property:=*’ respectively. Property triggers are additionally evaluated and triggered accordingly during the initial boot phase of init.

An Action can have multiple property triggers but may only have one event trigger.
on boot && property:val1=val2

The above line defines an action that is only executed when the ‘boot’ event trigger happens and the property val1 equals val2.
on property:val1=val2 && property:val3=val4

The above line defines an action that is executed at three times:

During initial boot if property val1=val2 and property val3=val4.
Any time that property val1 transitions to value val2, while property val3 already equals val4.
Any time that property val3 transitions to value val4, while property a already equals val2.

Trigger Sequence
------------------
Init uses the following sequence of triggers during early boot. These are the built-in triggers defined in init.cpp.

**early-init**

The first in the sequence, triggered after cgroups has been configured but before ueventd's coldboot is complete.

**init**

Triggered after coldboot is complete.

**charger**

Triggered if ro.bootmode == "charger"

**late-init**

Triggered if ro.bootmode != "charger", or via healthd triggering a boot from charging mode.
Remaining triggers are configured in init.rc and are not built-in. The default sequence for these is specified under the “on late-init” event in init.rc. Actions internal to init.rc have been omitted.

**early-fs**

Start vold

**fs**

Vold is up. Mount partitions not marked as first-stage or latemounted.

**post-fs**

Configure anything dependent on early mounts.

**late-fs**

Mount partitions marked as latemounted.

**post-fs-data**

Mount and configure /data; set up encryption. /metadata is reformatted here if it couldn't mount in first-stage init.

**zygote-start**

Start the zygote.

**early-boot**

After zygote has started.

**boot**

After early-boot actions have completed.

Commands
------------------
**bootchart [start|stop]**

Start/stop bootcharting. These are present in the default init.rc files, but bootcharting is only active if the file /data/bootchart/enabled exists; otherwise bootchart start/stop are no-ops.

**chmod <octal-mode> <path>**

Change file access permissions.

**chown <owner> <group> <path>**

Change file owner and group.

**class_start <serviceclass>**

Start all services of the specified class if they are not already running. See the start entry for more information on starting services.

**class_stop <serviceclass>**

Stop and disable all services of the specified class if they are currently running.

**class_reset <serviceclass>**

Stop all services of the specified class if they are currently running, without disabling them. They can be restarted later using class_start.

**class_restart [--only-enabled] <serviceclass>**

Restarts all services of the specified class. If --only-enabled is specified, then disabled services are skipped.

**copy <src> <dst>**

Copies a file. Similar to write, but useful for binary/large amounts of data. Regarding to the src file, copying from symbolic link file and world-writable or group-writable files are not allowed. Regarding to the dst file, the default mode created is 0600 if it does not exist. And it will be truncated if dst file is a normal regular file and already exists.

**copy_per_line <src> <dst>**

Copies a file line by line. Similar to copy, but useful for dst is a sysfs node that doesn't handle multiple lines of data.

**domainname <name>**

Set the domain name.

**enable <servicename>**

Turns a disabled service into an enabled one as if the service did not specify disabled. If the service is supposed to be running, it will be started now. Typically used when the bootloader sets a variable that indicates a specific service should be started when needed. E.g.

**on property:ro.boot.mytesthardware=1**

enable mytesthardware_service

**exec [ <seclabel> [ <user> [ <group>\ * ] ] ] -- <command> [ <argument>\* ]**

Fork and execute command with the given arguments. The command starts after “--” so that an optional security context, user, and supplementary groups can be provided. No other commands will be run until this one finishes. seclabel can be a - to denote default. Properties are expanded within argument. Init halts executing commands until the forked process exits.

**exec_background [ <seclabel> [ <user> [ <group>\* ] ] ] -- <command> [ <argument>\* ]**

Fork and execute command with the given arguments. This is handled similarly to the exec command. The difference is that init does not halt executing commands until the process exits for exec_background.

**exec_start <service>**

Start a given service and halt the processing of additional init commands until it returns. The command functions similarly to the exec command, but uses an existing service definition in place of the exec argument vector.

**export <name> <value>**

Set the environment variable name equal to value in the global environment (which will be inherited by all processes started after this command is executed)

**hostname <name>**

Set the host name.

**ifup <interface>**

Bring the network interface interface online.

**insmod [-f] <path> [<options>]**

Install the module at path with the specified options. -f: force installation of the module even if the version of the running kernel and the version of the kernel for which the module was compiled do not match.

**interface_start <name>**

**interface_restart <name>**

**interface_stop <name>**

Find the service that provides the interface name if it exists and run the start, restart, or stop commands on it respectively. name may be either a fully qualified HIDL name, in which case it is specified as <interface>/<instance>, or an AIDL name, in which case it is specified as aidl/<interface> for example android.hardware.secure_element@1.1::ISecureElement/eSE1 or aidl/aidl_lazy_test_1.

Note that these commands only act on interfaces specified by the interface service option, not on interfaces registered at runtime.

Example usage of these commands:
interface_start android.hardware.secure_element@1.1::ISecureElement/eSE1 will start the HIDL Service that provides the android.hardware.secure_element@1.1 and eSI1 instance.
interface_start aidl/aidl_lazy_test_1 will start the AIDL service that provides the aidl_lazy_test_1 interface.

**load_exports <path>**

Open the file at path and export global environment variables declared there. Each line must be in the format export <name> <value>, as described above.

**loglevel <level>**

Sets init's log level to the integer level, from 7 (all logging) to 0 (fatal logging only). The numeric values correspond to the kernel log levels, but this command does not affect the kernel log level. Use the write command to write to /proc/sys/kernel/printk to change that. Properties are expanded within level.

**restart [--only-if-running] <service>**

Stops and restarts a running service, does nothing if the service is currently restarting, otherwise, it just starts the service. If “--only-if-running” is specified, the service is only restarted if it is already running.

**rm <path>**

Calls unlink(2) on the given path. You might want to use “exec -- rm ...” instead (provided the system partition is already mounted).

**setprop <name> <value>**

Set system property name to value. Properties are expanded within value.

**setrlimit <resource> <cur> <max>**

Set the rlimit for a resource. This applies to all processes launched after the limit is set. It is intended to be set early in init and applied globally. resource is best specified using its text representation (‘cpu’, ‘rtio’, etc or ‘RLIM_CPU’, ‘RLIM_RTIO’, etc). It also may be specified as the int value that the resource enum corresponds to. cur and max can be ‘unlimited’ or ‘-1’ to indicate an infinite rlimit.

**start <service>**

Start a service running if it is not already running. Note that this is not synchronous, and even if it were, there is no guarantee that the operating system‘s scheduler will execute the service sufficiently to guarantee anything about the service’s status. See the exec_start command for a synchronous version of start.

This creates an important consequence that if the service offers functionality to other services, such as providing a communication channel, simply starting this service before those services is not sufficient to guarantee that the channel has been set up before those services ask for it. There must be a separate mechanism to make any such guarantees.

**stop <service>**

Stop a service from running if it is currently running.

**trigger <event>**

Trigger an event. Used to queue an action from another action.

**umount <path>**

Unmount the filesystem mounted at that path.

**wait <path> [ <timeout> ]**

Poll for the existence of the given file and return when found, or the timeout has been reached. If timeout is not specified it currently defaults to five seconds. The timeout value can be fractional seconds, specified in floating point notation.

**wait_for_prop <name> <value>**

Wait for system property name to be value. Properties are expanded within value. If property name is already set to value, continue immediately.

**write <path> <content>**

Open the file at path and write a string to it with write(2). If the file does not exist, it will be created. If it does exist, it will be truncated. Properties are expanded within content.

Reference:
--------------
[1]: ``https://android.googlesource.com/platform/system/core/+/master/init/README.md``



 


 
